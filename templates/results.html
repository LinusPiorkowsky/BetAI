<!-- templates/results.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ML Bets - Results</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <!-- Navbar -->
  <nav>
    <div class="nav-left">Machine Learning Bets</div>
    <div class="nav-right">
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('predictions') }}">Predictions</a>
      <a href="{{ url_for('results') }}">Results</a>
      <a href="{{ url_for('informations') }}">FAQ</a>
    </div>
  </nav>

  <!-- Header / Filter Section -->
  <header>
    <h1>Past Results</h1>
    <p class="date-range">
      Use filters to find specific leagues or high confidence picks.
    </p>

    <!-- Filters -->
    <div class="filters">
      <label for="league-select">League:</label>
      <select id="league-select">
        <option value="all" selected>All</option>
        {% for league_code in leagues %}
          <option value="{{ league_code }}">
            {{ league_code }}
          </option>
        {% endfor %}
      </select>

      <label for="week-select">Week:</label>
      <select id="week-select">
        <option value="all" selected>All</option>
        {% for w in weeks %}
          <option value="{{ w }}">{{ w }}</option>
        {% endfor %}
      </select>

      <label for="high-conf">
        <input type="checkbox" id="high-conf">
        High Confidence
      </label>
    </div>
  </header>

  <!-- Cards Container -->
  <div class="cards-container" id="results-container">
    {% if results is not none and results.shape[0] > 0 %}
      {% for idx, p in results.iterrows() %}
        {# 
          We color-code the card if BetCorrect = True => green, else red
          We'll do it with a simple check for "correct" or "wrong".
        #}
        {% set correctness_class = 'correct' if p['BetCorrect'] else 'wrong' %}

        <div 
          class="prediction-card {{ correctness_class }}"
          data-league="{{ p['Div'] }}"
          data-highconf="{{ p['High_conf'] }}"
          data-week="{{ p['Week'] }}"
        >
          <!-- Top row: Date, Weekday, Time -->
          <div class="card-top">
            <span>
              {# 'Weekday' is a column in your CSV? If not, remove or adapt #}
              {% if 'Weekday' in p and p['Weekday'] %}
                {{ p['Weekday'] }}
              {% endif %}
              {% if p['Date'] %}
                {{ p['Date'].strftime('%d.%m.%Y') }}
              {% endif %}
              {% if 'Time' in p and p['Time'] %}
                {{ p['Time'] }}
              {% endif %}
            </span>
          </div>

          <!-- Middle: HomeTeam vs. AwayTeam -->
          <div class="card-middle">
            <div class="matchup">
              <span>{{ p['HomeTeam'] }} vs. {{ p['AwayTeam'] }}</span>
            </div>

            <!-- Start with the final bet as determined in your DataFrame -->
            <div class="prediction-info">
              {% set predicted_bet = p['FinalBet'] %}
              {% set predicted_odd = 0 %}
              {% set predicted_prob = 0 %}

              {# 
                The next blocks replicate your snippet:
                If final bet == 'H' or 'D' or 'A', 
                we (re)check probabilities to see if we switch to '1X' or 'X2'
              #}
              {% if predicted_bet == 'H' %}
                {# If Prob_H <= 0.6 => "1X" else "H" #}
                {% if p['Prob_H'] <= 0.6 %}
                  {% set predicted_odd = p['1X_odds'] %}
                  {% set predicted_bet = '1X' %}
                  {% set predicted_prob = p['Prob_D'] + p['Prob_h'] %}
                {% else %}
                  {% set predicted_odd = p['B365H'] %}
                  {% set predicted_prob = p['Prob_H'] %}
                  {% set predicted_bet = p['HomeTeam'] %}
                {% endif %}

              {% elif predicted_bet == 'D' %}
                {# If (prob_h + prob_d) > (prob_d + prob_a) => '1X' else 'X2' #}
                {% if p['Prob_H'] + p['Prob_D'] > p['Prob_D'] + p['Prob_A'] %}
                  {% set predicted_bet = '1X' %}
                  {% set predicted_prob = p['Prob_D'] + p['Prob_H'] %}
                  {% set predicted_odd = p['1X_odds'] %}
                {% else %}
                  {% set predicted_bet = 'X2' %}
                  {% set predicted_prob = p['Prob_D'] + p['Prob_A'] %}
                  {% set predicted_odd = p['X2_odds'] %}
                {% endif %}

              {% elif predicted_bet == 'A' %}
                {# If High_conf == 1 => "A" else "X2" #}
                {% if p['High_conf'] == 1 %}
                  {% set predicted_bet = p['AwayTeam'] %}
                  {% set predicted_prob = p['Prob_A'] %}
                  {% set predicted_odd = p['B365A'] %}
                {% else %}
                  {% set predicted_bet = 'X2' %}
                  {% set predicted_prob = p['Prob_D'] + p['Prob_A'] %}
                  {% set predicted_odd = p['X2_odds'] %}
                {% endif %}
              {% endif %}

              <!-- Output the final values (bet, odd, confidence, score, etc.) -->
              Prediction: 
              <span class="highlight">
                {{ predicted_bet }} - {{ predicted_odd }}
              </span>
              <br>
              Confidence: 
              <span class="highlight">
                {{ (predicted_prob * 100) | round(1) }}%
              </span>
              <br>
              Result:
              <span class="highlight">
                {% if 'Score' in p and p['Score'] %}
                  {{ p['Score'] }}
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>No results found.</p>
    {% endif %}
  </div>

  <!-- JavaScript for filtering by league, week, and high confidence -->
  <script>
    const leagueSelect = document.getElementById('league-select');
    const weekSelect = document.getElementById('week-select');
    const highConfCheckbox = document.getElementById('high-conf');
    const cards = document.querySelectorAll('.prediction-card');

    function filterResults() {
      const selectedLeague = leagueSelect.value;
      const selectedWeek = weekSelect.value;
      const highConfOnly = highConfCheckbox.checked;

      cards.forEach(card => {
        const cardLeague = card.getAttribute('data-league');
        const cardWeek = card.getAttribute('data-week');
        const cardHighConf = card.getAttribute('data-highconf');

        let show = true;

        // Filter league
        if (selectedLeague !== 'all' && cardLeague !== selectedLeague) {
          show = false;
        }

        // Filter week
        if (selectedWeek !== 'all' && cardWeek !== selectedWeek) {
          show = false;
        }

        // Filter high conf
        if (highConfOnly && cardHighConf !== '1') {
          show = false;
        }

        card.style.display = show ? 'block' : 'none';
      });
    }

    leagueSelect.addEventListener('change', filterResults);
    weekSelect.addEventListener('change', filterResults);
    highConfCheckbox.addEventListener('change', filterResults);

    // Initial filter on page load
    filterResults();
  </script>
</body>
</html>
